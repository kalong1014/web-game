<!DOCTYPE html>  
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"> 
<meta content="email=no,telephone=no" name="format-detection"/>
<title>注册</title>
<link href="/template/default/css/logreg.css" rel="stylesheet" type="text/css">
<script src="/template/default/js/jquery.min.js"></script>
<script>
	function register(id, result) {
		if(result) {
			$('registersubmit').disabled = true;
			window.location.href = "$jumpurl";
		} else {
			updateseccode();
		}
	}
</script>
<script type="text/javascript">

    $('#username').focus();
    var lastUserName = lastPassword = lastEmail = lastSecCode = '';
    function checkUserName() {
        var userName = $('#username').val();
        if (userName == lastUserName) {
            return;
        } else {
            lastUserName = userName;
        }
        var cu = $('#username_ts');
        var unLen = userName.replace(/[^\x00-\xff]/g, "**").length;

        if (unLen < 3 || unLen > 15) {
            warning(cu, unLen < 3 ? '用户名小于3个字符' : '用户名超过 15 个字符');
            return;
        }else{
			$('#username_ts').html('');
		}
        ajaxresponse('username_ts', 'op=checkusername&username=' + userName);
        
    }
    function checkPassword(confirm) {
        var password = $('#password').val();
        if (!confirm && password == lastPassword) {
            return;
        } else {
            lastPassword = password;
        }
        var cp = $('#password_ts');
		 var pwdlen = password.length;
		var re = /[\'\"\\]/;
        if (password == '' || re.test(password)) {
            warning(cp, '密码空或包含非法字符');
            return false;
        }else if(pwdlen<6 || pwdlen > 18){
		 	warning(cp, pwdlen < 6 ? '密码长度小于6个字符' : '密码超过 18 个字符');
            return;
			
		} else {
            cp.show();
            //cp.innerHTML = '<img src="image/check_right.gif" width="13" height="13">';
            cp.addClass("success");
            if (!confirm) {
                checkPassword2(true);
            }
            return true;
        }
    }
    function checkPassword2(confirm) {
        var password = $('#password').val();
        var password2 = $('#password2').val();
        var cp2 = $('#repassword_ts');
        if (password2 != '') {
            checkPassword(true);
        }
        if (password == '' || (confirm && password2 == '')) {
            cp2.hide();
            return;
        }
        if (password != password2) {
            warning(cp2, '两次输入的密码不一致');
        } else {
            cp2.show();

            cp2.html('');
            cp2.addClass ("success");
        }
    }
    function checkSeccode() {
        var seccodeVerify = $('#seccode').val();
        ajaxresponse('seccode_ts', 'op=checkseccode&seccode=' + (is_ie && document.charset == 'utf-8' ? encodeURIComponent(seccodeVerify) : seccodeVerify));
    }

    function checkEmail() {
        var cp2 = $('#email_ts');
        var email = $('#email').val();
        res = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/;
        var re = new RegExp(res);
        if (email.match(re) == null) {
            cp2.show();
            cp2.addClass( "error");
            cp2.html('请输入正确的Email地址');

        } else {
            cp2.show();
            cp2.html( '');
            cp2.addClass("success");
        }

    }

	function ajaxresponse(objname, data) {
		var x = new Ajax('XML', objname);
		x.get('index.php?ac=register&' + data, function(s){
			var obj = $(objname);
			s = trim(s);
			if(s.indexOf('succeed') > -1) {
				obj.style.display = '';
				obj.innerHTML = '<img src="image/check_right.gif" width="13" height="13">';
				obj.className = "warning";
			} else {
				warning(obj, s);
			}
		});
	}
    
    function warning(obj, msg) {
        if ((ton = obj.attr("id").substr(5, obj.attr("id").length)) != 'password2') {
            $(ton).select();
        }
        obj.show();
        obj.html('&nbsp; ' + msg);
        obj.removeClass("success");
        obj.addClass("error");
    }

    function checkPwd(pwd) {

        if (pwd == "") {
            $("#password_ts").className = "";
            $("#password_ts").html("");
        } else if (pwd.length < 3) {
            $("#password_ts").addClass("success");
            $("#password_ts").html("&nbsp;&nbsp;太短");
        } else if (!isPassword(pwd) || !/^[^%&]*$/.test(pwd)) {
            $("#password_ts").className = "";
            $("#password_ts").html("");
        } else {
            var csint = checkStrong(pwd);
            switch (csint) {
                case 1:
                    $("#password_ts").html("&nbsp;&nbsp;很弱");
                    $("#password_ts").addClass("success");
                    break;
                case 2:
                    $("#password_ts").html("&nbsp;&nbsp;一般");
                    $("#password_ts").addClass("success");
                    break;
                case 3:
                    $("#password_ts").html("&nbsp;&nbsp;很强");
                    $("#password_ts").addClass("success");
                    break;
            }
        }
    }
    function isPassword(str) {
        if (str.length < 3) return false;
        var len;
        var i;
        len = 0;
        for (i = 0; i < str.length; i++) {
            if (str.charCodeAt(i) > 255) return false;
        }
        return true;
    }
    function charMode(iN) {
        if (iN >= 48 && iN <= 57) //数字 
            return 1;
        if (iN >= 65 && iN <= 90) //大写字母 
            return 2;
        if (iN >= 97 && iN <= 122) //小写 
            return 4;
        else
            return 8; //特殊字符 
    }
    //计算出当前密码当中一共有多少种模式 
    function bitTotal(num) {
        modes = 0;
        for (i = 0; i < 4; i++) {
            if (num & 1) modes++;
            num >>>= 1;
        }
        return modes;
    }

    //返回密码的强度级别 
    function checkStrong(pwd) {
        modes = 0;
        for (i = 0; i < pwd.length; i++) {
            //测试每一个字符的类别并统计一共有多少种模式. 
            modes |= charMode(pwd.charCodeAt(i));
        }
        return bitTotal(modes);
    }
    //验证码
    function seccode() {
        var img = 'index.php?ac=seccode&rand=' + Math.random();
        document.writeln('<img id="img_seccode" src="' + img + '" align="absmiddle">');
		alert(rand);
    }
    function updateseccode() {
        var img = 'index.php?ac=seccode&rand=' + Math.random();
        if ($('#img_seccode')) {        　
            $("#img_seccode").attr("src", img);         
        }
    }
	
</script>
</head>
<body>
<div id="header">
  <div class="logregnav"><a href="javascript:history.back()" class="fanhui"><em>返回</em></a><span>免费注册</span></div>
</div>
<div id="main">
  <div class="layout">
    <div class="log">
      <form action="/index.php?ac=register&$url_plus&ref" method="post" name="registerform">
      <ul>
        <li class="form_li">
          <div class="form_tit">用户名</div>
          <div class="form_con">
            <input class="textinput" type="text" name="username" id="username" onBlur="checkUserName()">
          </div>
        </li>
        <li class="form_ts" id="username_ts"></li>
        <li class="form_li">
          <div class="form_tit">密码</div>
          <div class="form_con">
            <input class="textinput" type="password" name="password" id="password" onBlur="checkPassword()">
          </div>
        </li>
        <li class="form_ts" id="password_ts"></li>
        <li class="form_li">
          <div class="form_tit">重复密码</div>
          <div class="form_con">
            <input class="textinput" type="password" name="password2" id="password2" onBlur="checkPassword2()">
          </div>
        </li>
        <li class="form_ts" id="repassword_ts"></li>
        <li class="form_li">
          <div class="form_tit">电子邮箱</div>
          <div class="form_con">
            <input class="textinput" type="text" name="email" id="email" onBlur="checkEmail()">
          </div>
        </li>
        <li class="form_ts" id="email_ts"></li>
        <!--{if $_SCONFIG['qiyongyzm']}-->
        <li class="form_li yzmcon_li">
          <div class="form_tit yzmcon_tit">验证码</div>
          <div class="yzmcon">
            <input class="yzminput" type="text" name="seccode" id="seccode" onBlur="checkSeccode()">
            <div class="yzmtu"><script>seccode();</script><a href="javascript:updateseccode()"><img class="shuaxin" src="/template/default/images/shuaxin.png"></a></div>
          </div>
        </li>
        <li class="form_ts" id="seccode_ts"></li>
        <!--{/if}-->
        <li>
          <input type="hidden" name="refer" value="{$_GET['refer']}" />
          <input type="hidden" name="formhash" value="<!--{eval echo formhash();}-->" />
          <input type="hidden" name="template" value="{$_SCONFIG[stemplate]}"/>
          <input type="submit" name="registersubmit" id="registersubmit" class="tijiao" value="免费注册">
        </li>
      </ul>
      </form>
    </div>
  </div>
</div>
<div id="footer">
</div>
</body>
</html>
